syntax = "proto3";

package kms.api.cmk.registry.auth.v1;

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

service Service {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    name: "Auth"
  };

  rpc ApplyAuth(ApplyAuthRequest) returns (ApplyAuthResponse) {
    option (google.api.http) = {
      post: "/v1/auth"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Apply authentication configuration"
      description: "Creates or updates authentication configuration for a tenant. Use this endpoint to configure authentication methods like OIDC. For OIDC authentication, provide the issuer URL, JWKS URI, and audiences in the properties field."
      tags: ["Auth"]
    };
  }
  rpc GetAuth(GetAuthRequest) returns (GetAuthResponse) {
    option (google.api.http) = {
      get: "/v1/auth/{external_id}"
    };
  }
  rpc ListAuths(ListAuthsRequest) returns (ListAuthsResponse) {
    option (google.api.http) = {
      get: "/v1/auths"
    };
  }
  rpc RemoveAuth(RemoveAuthRequest) returns (RemoveAuthResponse) {
    option (google.api.http) = {
      delete: "/v1/auth/{external_id}"
    };
  }
}

message Auth {
  string external_id = 1;
  string tenant_id = 2;
  string type = 3;
  map<string, string> properties = 4;
  AuthStatus status = 5;
  string error_message = 6;
  string updated_at = 7;
  string created_at = 8;
}

message ApplyAuthRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Apply Auth Request"
      description: "Request message for applying authentication configuration to a tenant"
      example: "{ \"external_id\": \"auth-123\", \"tenant_id\": \"tenant-abc\", \"type\": \"OIDC\", \"properties\": { \"issuer\": \"https://issuer.example\", \"jwks_uris\": \"https://issuer.example/.well-known/jwks.json\", \"audiences\": \"aud1,aud2\" } }"
    }
  };

  string external_id = 1 [(.grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "External identifier for the authentication configuration"
  }];
  string tenant_id = 2 [(.grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Unique identifier of the tenant"
  }];
  string type = 3 [(.grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Type of authentication to be applied (e.g., OIDC)"
  }];
  map<string, string> properties = 4 [(.grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {
    description: "Key-value pairs representing authentication properties. For OIDC this should be issuer, jwks_uris and audiences."
  }];
}

message ApplyAuthResponse {
  bool success = 1;
}

message GetAuthRequest {
  string external_id = 1;
}

message GetAuthResponse {
  Auth auth = 1;
}

message ListAuthsRequest {
  string tenant_id = 1;

  int32 limit = 2; // default value is 50; max value is 1000
  string next_page_token = 3;
}

message ListAuthsResponse {
  repeated Auth auth = 1;

  string next_page_token = 2;
}

message RemoveAuthRequest {
  string external_id = 1;
}

message RemoveAuthResponse {
  bool success = 1;
}

enum AuthStatus {
  AUTH_STATUS_UNSPECIFIED = 0;
  AUTH_STATUS_APPLYING = 1;
  AUTH_STATUS_APPLYING_ERROR = 2;
  AUTH_STATUS_APPLIED = 3;
  AUTH_STATUS_REMOVING = 4;
  AUTH_STATUS_REMOVING_ERROR = 5;
  AUTH_STATUS_REMOVED = 6;
}

enum AuthAction {
  AUTH_ACTION_UNSPECIFIED = 0;
  AUTH_ACTION_APPLY_AUTH = 1;
  AUTH_ACTION_REMOVE_AUTH = 2;
}
