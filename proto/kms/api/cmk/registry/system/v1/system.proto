syntax = "proto3";

package kms.api.cmk.registry.system.v1;

import "google/api/annotations.proto";
import "kms/api/cmk/types/v1/status.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

service Service {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    name: "System"
  };

  rpc RegisterSystem(RegisterSystemRequest) returns (RegisterSystemResponse) {
    option (google.api.http) = {
      post: "/v1/system"
      body: "*"
    };
  }
  rpc ListSystems(ListSystemsRequest) returns (ListSystemsResponse) {
    option (google.api.http) = {
      get: "/v1/systems"
    };
  }
  rpc DeleteSystem(DeleteSystemRequest) returns (DeleteSystemResponse) {
    option (google.api.http) = {
      delete: "/v1/system/{external_id}"
    };
  }
  rpc UpdateSystemL1KeyClaim(UpdateSystemL1KeyClaimRequest) returns (UpdateSystemL1KeyClaimResponse) {
    option (google.api.http) = {
      patch: "/v1/system/{external_id}/l1key-claim"
      body: "*"
    };
  }
  rpc UnlinkSystemsFromTenant(UnlinkSystemsFromTenantRequest) returns (UnlinkSystemsFromTenantResponse) {
    option (google.api.http) = {
      post: "/v1/systems/unlink"
      body: "*"
    };
  }
  rpc LinkSystemsToTenant(LinkSystemsToTenantRequest) returns (LinkSystemsToTenantResponse) {
    option (google.api.http) = {
      post: "/v1/systems/link"
      body: "*"
    };
  }
  rpc UpdateSystemStatus(UpdateSystemStatusRequest) returns (UpdateSystemStatusResponse) {
    option (google.api.http) = {
      patch: "/v1/system/{external_id}/status"
      body: "*"
    };
  }
  rpc SetSystemLabels(SetSystemLabelsRequest) returns (SetSystemLabelsResponse) {
    option (google.api.http) = {
      patch: "/v1/system/{external_id}/labels"
      body: "*"
    };
  }
  rpc RemoveSystemLabels(RemoveSystemLabelsRequest) returns (RemoveSystemLabelsResponse) {
    option (google.api.http) = {
      delete: "/v1/system/{external_id}/labels"
      body: "*"
    };
  }
}

message System {
  string external_id = 1;
  string tenant_id = 2;
  string l2key_id = 3;
  bool has_l1key_claim = 4;
  string region = 5;
  string type = 6;
  kms.api.cmk.types.v1.Status status = 7;
  string updated_at = 8;
  string created_at = 9;
  map<string, string> labels = 10;
}

message RegisterSystemRequest {
  string external_id = 1;
  string tenant_id = 2;
  string l2key_id = 3;
  bool has_l1key_claim = 4;
  string region = 5;
  kms.api.cmk.types.v1.Status status = 7;
  string type = 8;
  map<string, string> labels = 9;
}

message RegisterSystemResponse {
  bool success = 1;
}

message ListSystemsRequest {
  string external_id = 1;
  string region = 2;
  string tenant_id = 3;
  string type = 4;

  // Default value is 50.
  // Max value is 1000.
  int32 limit = 5;
  // Next page token.
  string page_token = 6;
}

message ListSystemsResponse {
  repeated System systems = 1;

  // Token of the next pagination page.
  string next_page_token = 2;
}

message DeleteSystemRequest {
  string external_id = 1;
  string region = 2;
}

message DeleteSystemResponse {
  bool success = 1;
}

message UpdateSystemL1KeyClaimRequest {
  string external_id = 1;
  string region = 2;
  string tenant_id = 3;
  bool l1key_claim = 4;
}

message UpdateSystemL1KeyClaimResponse {
  bool success = 1;
}

message UnlinkSystemsFromTenantRequest {
  repeated SystemIdentifier system_identifiers = 1;
}

message UnlinkSystemsFromTenantResponse {
  bool success = 1;
}

message LinkSystemsToTenantRequest {
  repeated SystemIdentifier system_identifiers = 1;
  string tenant_id = 2;
}

message LinkSystemsToTenantResponse {
  bool success = 1;
}

message UpdateSystemStatusRequest {
  string external_id = 1;
  string region = 2;
  kms.api.cmk.types.v1.Status status = 3;
}

message UpdateSystemStatusResponse {
  bool success = 1;
}

message SystemIdentifier {
  string external_id = 1;
  string region = 2;
}

message SetSystemLabelsRequest {
  string external_id = 1;
  string region = 2;
  map<string, string> labels = 3;
}

message SetSystemLabelsResponse {
  bool success = 1;
}

message RemoveSystemLabelsRequest {
  string external_id = 1;
  string region = 2;
  repeated string label_keys = 3; // Keys of labels to delete
}

message RemoveSystemLabelsResponse {
  bool success = 1;
}
